<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <title>Сотрудники</title>
  <link rel="stylesheet" href="style_db.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="icon.png">
  <script src="usermenu.js"></script> 
</head>

<body>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="sidebar" id="sidebar"> 
    <div class="sidebar-header">
        <span class="logo">РОТОР</span>
    </div>

    <ul class="sidebar-menu">
        <li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>Личный кабинет</span></a></li>
        <li><a href="employees.html"><i class="fas fa-users"></i><span>Список сотрудников</span></a></li>
        <li><a href="routes.html"><i class="fas fa-route"></i><span>Маршруты</span></a></li>
        <li><a href="vehicles.html"><i class="fas fa-truck"></i><span>Список ПС</span></a></li>
        <li><a href="submit_route.html"><i class="fas fa-file"></i><span>Маршрутный лист</span></a></li>
        <li><a href="charter.html"><i class="fas fa-book"></i><span>Устав</span></a></li>
        <li><a href="plan.html"><i class="fas fa-calendar"></i><span>План</span></a></li>
        <li><a href="t.html"><i class="fas fa-check"></i><span>Тесты</span></a></li>
        <li><a href="binds.html"><i class="fas fa-keyboard"></i><span>Бинды и таблички</span></a></li>
    </ul>

    <div class="user-menu" id="userMenu">

      <div class="user-menu-item" id="nyBtn">
      <i class="fas fa-snowflake"></i>
      <span>НГ оформление</span>
      </div>

    <div class="user-menu-item" id="themeBtn">
        <i class="fas fa-moon"></i>
        <span>Тёмная тема</span>
    </div>

    <div class="user-menu-item" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Выйти</span>
    </div>

    <div class="user-name-display">
        <i class="fas fa-user"></i>
        <span id="userName">user</span>
    </div>

</div>


</div>
<div class="main-content">
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Список сотрудников</h1>

    <button id="manageEmployeesBtn"
            style="display:none; padding: 8px 14px; font-size: 14px; cursor: pointer;">
        Управление сотрудниками
    </button>

    <button id="manageUCBtn"
            style="display:none; padding: 8px 14px; font-size: 14px; cursor: pointer;">
        Учебный центр
    </button>
</div>

    <div id="loading" class="loading">Получение информации от сервера...</div>
    <table class="table" id="usersTable" style="display:none;">
      <thead>
        <tr>
          <th>Ник</th>
          <th>Должность</th>
          <th>ВК</th>
          <th>Выговоры</th>
          <th>Счёт</th>
        </tr>
      </thead>
      <tbody id="usersBody">
      </tbody>
    </table>
  </div>
</div>
  <script>
const pageAccess = null;

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
}


const ALLOWED_POSTS_EMP = [
    "Директор",
    "Зам. директора",
    "Технический администратор"
];

const ALLOWED_POSTS_UC = [
    "Директор",
    "Зам. директора",
    "Технический администратор",
    "Начальник учебного центра",
    "Инструктор"
];

async function checkButtonsAccess() {
    const username = getCookie("userLogin");
    if (!username) return;

    try {
        const response = await fetch("https://rotorbus.ru/api/get_user/rotor", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: username })
        });

        const json = await response.json();
        if (json.status !== "ok") return;

        const post = json.post;

        if (ALLOWED_POSTS_EMP.includes(post)) {
            document.getElementById("manageEmployeesBtn").style.display = "inline-block";
        }

        if (ALLOWED_POSTS_UC.includes(post)) {
            document.getElementById("manageUCBtn").style.display = "inline-block";
        }

    } catch (e) {
        console.error(e);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("manageEmployeesBtn").onclick =
        () => window.location.href = "employees-a.html";

    document.getElementById("manageUCBtn").onclick =
        () => window.location.href = "trainees_uc.html";

    checkButtonsAccess();
});



const API_URL = "https://rotorbus.ru/api/get_users/rotor";

async function loadUsers() {
    const table = document.getElementById('usersTable');
    const tbody = document.getElementById('usersBody');
    const loading = document.getElementById('loading');

    try {
        const response = await fetch(API_URL, {
            method: "GET",
            headers: { "Accept": "application/json" }
        });

        if (!response.ok) {
            throw new Error("Ошибка сервера: " + response.status);
        }

        const json = await response.json();

        if (!json.status || json.status !== "ok") {
            throw new Error(json.message || "Неизвестная ошибка API");
        }

        const users = sortUsersByPost(json.users);


        tbody.innerHTML = "";

        users.forEach(user => {
            const tr = document.createElement("tr");

            const vkUrl =
                user.vk && user.vk.startsWith("http")
                    ? user.vk
                    : user.vk
                        ? "https://" + user.vk
                        : "#";

            tr.innerHTML = `
                <td>${user.name || "-"}</td>
                <td>${user.post || "—"}</td>
                <td>
                    ${
                        user.vk
                            ? `<button class="vk-btn" onclick="window.open('${vkUrl}', '_blank')">VK</button>`
                            : `<span style="color:#888;">нет</span>`
                    }
                </td>
                <td>${user.disciplinary_actions || 0}</td>
                <td>${user.account || 0}</td>
            `;

            tbody.appendChild(tr);
        });

        loading.style.display = "none";
        table.style.display = "table";

    } catch (err) {
        loading.textContent = "Не удалось загрузить данные: " + err.message;
        console.error("loadUsers error:", err);
    }
}

const POST_ORDER = [
    "Директор",
    "Зам. директора",
    "Технический администратор",
    "Начальник учебного центра",
    "Инструктор",
    "Водитель 1 класса",
    "Водитель 2 класса",
    "Водитель 3 класса",
    "Водитель-стажер"
];

function sortUsersByPost(users) {
    return users.sort((a, b) => {
        const aIndex = POST_ORDER.indexOf(a.post);
        const bIndex = POST_ORDER.indexOf(b.post);

        if (aIndex === -1 && bIndex === -1) return 0;
        if (aIndex === -1) return 1;
        if (bIndex === -1) return -1;

        return aIndex - bIndex;
    });
}

loadUsers();


</script>



</body>
<script src="sidebar.js"></script>

</html>
