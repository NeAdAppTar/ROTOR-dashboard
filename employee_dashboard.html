<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <!-- <meta name="viewport" content="width=device-width,initial-scale=1"> -->
  <title>ROTOR ‚Äî –ü–∞–Ω–µ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</title>
  <link rel="stylesheet" href="style_db.css">
  <link rel="icon" type="image/png" href="icon.png">
  <script src="checkauth.js"></script>
  <script src="usermenu.js"></script> 
</head>

<body>

  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="sidebar" id="sidebar"> 
    <div class="sidebar-header">
        <span class="logo">–†–û–¢–û–†</span>
    </div>

    <ul class="sidebar-menu">
        <li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</span></a></li>
        <li><a href="employees.html"><i class="fas fa-users"></i><span>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span></a></li>
        <li><a href="routes.html"><i class="fas fa-route"></i><span>–ú–∞—Ä—à—Ä—É—Ç—ã</span></a></li>
        <li><a href="vehicles.html"><i class="fas fa-truck"></i><span>–°–ø–∏—Å–æ–∫ –ü–°</span></a></li>
        <li><a href="submit_route.html"><i class="fas fa-file"></i><span>–ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç</span></a></li>
        <li><a href="charter.html"><i class="fas fa-book"></i><span>–£—Å—Ç–∞–≤</span></a></li>
        <li><a href="plan.html"><i class="fas fa-calendar"></i><span>–ü–ª–∞–Ω</span></a></li>
        <li><a href="t.html"><i class="fas fa-check"></i><span>–¢–µ—Å—Ç—ã</span></a></li>
        <li><a href="binds.html"><i class="fas fa-keyboard"></i><span>–ë–∏–Ω–¥—ã –∏ —Ç–∞–±–ª–∏—á–∫–∏</span></a></li>
    </ul>

    <div class="user-menu" id="userMenu">

    <span class="user-name" id="userName">user</span>

    <div class="dropdown" id="dropdownMenu">
        <button id="logoutBtn">–í—ã–π—Ç–∏</button>
        <button id="themeBtn">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
    </div>

</div>

</div>

</div>


<div class="main-content">

  <div class="dashboard">
    <div class="tile">
      <h3>–ù–∏–∫–Ω–µ–π–º</h3>
      <p class="highlight" id="nickname">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <div class="tile">
      <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å–µ–≥–æ</h3>
      <p>–ö—Ä—É–≥–æ—Ä–µ–π—Å–æ–≤: <span class="highlight" id="totalRoutes">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
      <p>–ü–∞—Å—Å–∞–∂–∏—Ä–æ–≤: <span class="highlight" id="totalPassengers">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
    </div>

    <div class="tile">
      <h3>–¢–µ–∫—É—â–∏–π –ø–æ–ª—É–ø–µ—Ä–∏–æ–¥</h3>
      <p>–ö—Ä—É–≥–æ—Ä–µ–π—Å–æ–≤: <span class="highlight" id="periodRoutes">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>

      <div class="progress-container">
        <div class="progress-bar" id="routesProgress"></div>
        <span class="progress-label" id="routesProgressLabel">0 / 16</span>
      </div>

      <p>–ü–∞—Å—Å–∞–∂–∏—Ä–æ–≤: <span class="highlight" id="periodPassengers">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
    </div>

    <div class="tile">
      <h3>–û–∫–ª–∞–¥ –∑–∞ –ø–æ–ª—É–ø–µ—Ä–∏–æ–¥</h3>
      <p class="highlight" id="salary">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <div class="tile important">
      <p>–í–æ–¥–∏—Ç–µ–ª—å, –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–º–µ–Ω—ã –Ω–µ –∑–∞–±—ã–≤–∞–π —Å–¥–∞–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç</p>
    </div>

   <a href="https://dashboard.rotorbus.ru/11h1" target="_blank" class="tile important" style="text-decoration: none; color: inherit;">
      <p>–í—ã–ø–ª–∞—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã –∑–∞ –ø–µ—Ä–≤—ã–π –ø–æ–ª—É–ø–µ—Ä–∏–æ–¥ –Ω–æ—è–±—Ä—è (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ)</p>
    </a>

  </div>
</div>
  <script>
    function formatNumber(value) {
      if (value === null || value === undefined) return '0';
      const str = String(value).trim();
      if (str.includes('.')) {
        const [int, dec] = str.split('.');
        return dec === '0' ? int : str;
      }
      return str;
    }

    async function loadDashboard() {
  const login = localStorage.getItem('userLogin');

  const nickname = document.getElementById('nickname');
  const totalRoutes = document.getElementById('totalRoutes');
  const totalPassengers = document.getElementById('totalPassengers');
  const periodRoutes = document.getElementById('periodRoutes');
  const periodPassengers = document.getElementById('periodPassengers');
  const salary = document.getElementById('salary');

  nickname.textContent = login;

  const userPanelName = document.querySelector('.sidebar .user-panel .user-name');
  const userMenuName = document.querySelector('.user-menu .user-name');

  if(userPanelName) userPanelName.textContent = login;
  if(userMenuName) userMenuName.textContent = login;

  try {
    const response = await fetch('https://rotor.pythonanywhere.com/user_info', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login })
    });

    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');

    const data = await response.json();

    totalRoutes.textContent = formatNumber(data.all_routes);
    totalPassengers.textContent = formatNumber(data.all_passengers);
    periodRoutes.textContent = formatNumber(data.half_routes);
    periodPassengers.textContent = formatNumber(data.half_passengers);
    salary.textContent = data.salary ? formatNumber(data.salary) + ' ‚ÇΩ' : '0 ‚ÇΩ';

    const routesProgress = document.getElementById('routesProgress');
    const routesProgressLabel = document.getElementById('routesProgressLabel');

    const current = parseFloat(data.half_routes) || 0;
    const max = 16;
    let percent = (current / max) * 100;
    if (percent > 100) percent = 100;

    routesProgress.style.width = percent + '%';
    routesProgressLabel.textContent = `${formatNumber(current)} / ${max}`;

    if (current > max) {
      routesProgress.classList.add('progress-over');
    } else {
      routesProgress.classList.remove('progress-over');
    }

  } catch (error) {
    totalRoutes.textContent = '–û—à–∏–±–∫–∞';
    totalPassengers.textContent = '–û—à–∏–±–∫–∞';
    periodRoutes.textContent = '–û—à–∏–±–∫–∞';
    periodPassengers.textContent = '–û—à–∏–±–∫–∞';
    salary.textContent = '–û—à–∏–±–∫–∞';
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
  }
}



    function logout() {
      localStorage.removeItem('userLogin');
      document.cookie = "userLogin=; path=/; domain=.rotorbus.ru; expires=Thu, 01 Jan 1970 00:00:00 GMT";
      window.location.href = "https://auth.rotorbus.ru/";
    }

    window.addEventListener('DOMContentLoaded', loadDashboard);

const sidebar = document.getElementById("sidebar");

sidebar.addEventListener("click", (e) => {
    if (e.target.closest("a")) return;

    sidebar.classList.toggle("collapsed");
});

const userPanel = document.getElementById("userPanel");

  </script>
</body>

</html>