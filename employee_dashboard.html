<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <!-- <meta name="viewport" content="width=device-width,initial-scale=1"> -->
  <title>Панель сотрудника</title>
  <link rel="stylesheet" href="style_db.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="icon.png">

  <script src="usermenu.js"></script> 
</head>

<body>

  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="sidebar" id="sidebar"> 
    <div class="sidebar-header">
        <span class="logo">РОТОР</span>
    </div>

    <ul class="sidebar-menu">
        <li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>Личный кабинет</span></a></li>
        <li><a href="employees.html"><i class="fas fa-users"></i><span>Список сотрудников</span></a></li>
        <li><a href="routes.html"><i class="fas fa-route"></i><span>Маршруты</span></a></li>
        <li><a href="vehicles.html"><i class="fas fa-truck"></i><span>Список ПС</span></a></li>
        <li><a href="submit_route.html"><i class="fas fa-file"></i><span>Маршрутный лист</span></a></li>
        <li><a href="charter.html"><i class="fas fa-book"></i><span>Устав</span></a></li>
        <li><a href="plan.html"><i class="fas fa-calendar"></i><span>План</span></a></li>
        <li><a href="t.html"><i class="fas fa-check"></i><span>Тесты</span></a></li>
        <li><a href="binds.html"><i class="fas fa-keyboard"></i><span>Бинды и таблички</span></a></li>
    </ul>

    <div class="user-menu" id="userMenu">

      <div class="user-menu-item" id="nyBtn">
      <i class="fas fa-snowflake"></i>
      <span>НГ оформление</span>
      </div>
      
    <div class="user-menu-item" id="themeBtn">
        <i class="fas fa-moon"></i>
        <span>Тёмная тема</span>
    </div>

    <div class="user-menu-item" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Выйти</span>
    </div>

    <div class="user-name-display">
        <i class="fas fa-user"></i>
        <span id="userName">user</span>
    </div> 
</div>
</div>
</div>


<div class="main-content">

  <div class="dashboard">
    <div class="tile">
  <h3>Никнейм</h3>
  <p class="highlight" id="nickname">
    <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
  </p>

  <h3>Должность</h3>
  <p class="highlight" id="userRole">
    <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
  </p>
  <br>

  <button class="logout-btn" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i> Выйти
  </button>
</div>


<div class="tile">
  <h3>Статистика всего</h3>
  <p>Кругорейсов:
    <span class="highlight" id="totalRoutes">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>
  <p>Пассажиров:
    <span class="highlight" id="totalPassengers">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>
</div>

<div class="tile">
  <h3>Текущий полупериод</h3>

  <p>Кругорейсов:
    <span class="highlight" id="periodRoutes">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>

  <div class="progress-container">
    <div class="progress-bar" id="routesProgress"></div>
    <span class="progress-label" id="routesProgressLabel">0 / 16</span>
  </div>

  <p>Пассажиров:
    <span class="highlight" id="periodPassengers">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>

  <p>Зарплата:
    <span class="highlight" id="salary">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>
</div>

    <div class="tile important">
      <p>Водитель, при завершении смены не забывай сдавать маршрутный лист</p>
    </div>

  <div class="tile important">
  <p>Выплата зарплаты за первый полупериод декабря</p>

  <a href="https://dashboard.rotorbus.ru/12h1" 
     target="_blank" 
     class="button">
    Открыть
  </a>
</div> 


  </div>
</div>
  <script>

    function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
}

    const pageAccess = null;
    function formatNumber(value) {
      if (value === null || value === undefined) return '0';
      const str = String(value).trim();
      if (str.includes('.')) {
        const [int, dec] = str.split('.');
        return dec === '0' ? int : str;
      }
      return str;
    }

    async function loadDashboard() {
  const login = getCookie('userLogin');


  const nickname = document.getElementById('nickname');
  const totalRoutes = document.getElementById('totalRoutes');
  const totalPassengers = document.getElementById('totalPassengers');
  const periodRoutes = document.getElementById('periodRoutes');
  const periodPassengers = document.getElementById('periodPassengers');
  const salary = document.getElementById('salary');

  nickname.textContent = login;

  // Получение должности из второй БД
try {
    const postResponse = await fetch('https://rotorbus.ru/api/get_user/rotor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: login })
    });

    const postData = await postResponse.json();

    if (postData.status === "ok") {
        const roleElement = document.getElementById('userRole');
        if (roleElement) roleElement.textContent = postData.post || 'Не указана';
    } else {
        document.getElementById('userRole').textContent = 'Ошибка';
        console.warn("post error:", postData.message);
    }
} catch (e) {
    document.getElementById('userRole').textContent = 'Ошибка';
    console.error("Ошибка получения должности:", e);
}


  const userPanelName = document.querySelector('.sidebar .user-panel .user-name');
  const userMenuName = document.querySelector('.user-menu .user-name');

  if(userPanelName) userPanelName.textContent = login;
  if(userMenuName) userMenuName.textContent = login;

  try {
    const response = await fetch('https://rotor.pythonanywhere.com/user_info', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login })
    });

    if (!response.ok) throw new Error('Ошибка');

    const data = await response.json();

    totalRoutes.textContent = formatNumber(data.all_routes);
    totalPassengers.textContent = formatNumber(data.all_passengers);
    periodRoutes.textContent = formatNumber(data.half_routes);
    periodPassengers.textContent = formatNumber(data.half_passengers);
    salary.textContent = data.salary ? formatNumber(data.salary) + ' ₽' : '0 ₽';

    const routesProgress = document.getElementById('routesProgress');
    const routesProgressLabel = document.getElementById('routesProgressLabel');

    const current = parseFloat(data.half_routes) || 0;
    const max = 16;
    let percent = (current / max) * 100;
    if (percent > 100) percent = 100;

    routesProgress.style.width = percent + '%';
    routesProgressLabel.textContent = `${formatNumber(current)} / ${max}`;

    if (current > max) {
      routesProgress.classList.add('progress-over');
    } else {
      routesProgress.classList.remove('progress-over');
    }

  } catch (error) {
    totalRoutes.textContent = 'Ошибка';
    totalPassengers.textContent = 'Ошибка';
    periodRoutes.textContent = 'Ошибка';
    periodPassengers.textContent = 'Ошибка';
    salary.textContent = 'Ошибка';
    console.error('Ошибка:', error);
  }
}


    window.addEventListener('DOMContentLoaded', loadDashboard);

  </script>
</body>
<script src="sidebar.js"></script>
  <script src="checkauth.js"></script>
</html>