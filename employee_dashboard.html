<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <!-- <meta name="viewport" content="width=device-width,initial-scale=1"> -->
  <title>Панель сотрудника</title>
  <link rel="stylesheet" href="style_db.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="icon.png">

  <script src="usermenu.js"></script> 

  <style>
    .progress-over {
  background: linear-gradient(90deg, #ff5c5c, #ff9900);
}

  </style>
</head>

<body>

  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="sidebar" id="sidebar"> 
    <div class="sidebar-header">
        <span class="logo">РОТОР</span>
    </div>

    <ul class="sidebar-menu">
        <li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>Личный кабинет</span></a></li>
        <li><a href="employees.html"><i class="fas fa-users"></i><span>Список сотрудников</span></a></li>
        <li><a href="routes.html"><i class="fas fa-route"></i><span>Маршруты</span></a></li>
        <li><a href="vehicles.html"><i class="fas fa-truck"></i><span>Список ПС</span></a></li>
        <li><a href="shift_report.html"><i class="fas fa-file"></i><span>Отчет</span></a></li>
        <li><a href="charter.html"><i class="fas fa-book"></i><span>Устав</span></a></li>
        <li><a href="plan.html"><i class="fas fa-calendar"></i><span>План</span></a></li>
        <li><a href="t.html"><i class="fas fa-check"></i><span>Тесты</span></a></li>
        <li><a href="binds.html"><i class="fas fa-keyboard"></i><span>Бинды и таблички</span></a></li>
    </ul>

    <div class="user-menu" id="userMenu">

      <div class="user-menu-item" id="nyBtn">
      <i class="fas fa-snowflake"></i>
      <span>НГ оформление</span>
      </div>
      
    <div class="user-menu-item" id="themeBtn">
        <i class="fas fa-moon"></i>
        <span>Тёмная тема</span>
    </div>

    <div class="user-menu-item" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Выйти</span>
    </div>

    <div class="user-name-display">
        <i class="fas fa-user"></i>
        <span id="userName">user</span>
    </div> 
</div>
</div>
</div>


<div class="main-content">

  <div class="dashboard">
    <div class="tile">
  <h3>Никнейм</h3>
  <p class="highlight" id="nickname">
    <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
  </p>

  <h3>Должность</h3>
  <p class="highlight" id="userRole">
    <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
  </p>
  <br>

  <button class="logout-btn" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i> Выйти
  </button>
</div>


<div class="tile">
  <h3>Статистика всего</h3>
  <p>Кругорейсов:
    <span class="highlight" id="totalRoutes">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>
  <p>Пассажиров:
    <span class="highlight" id="totalPassengers">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>
</div>

<div class="tile">
  <h3>Текущий полупериод</h3>

  <p>Кругорейсов:
    <span class="highlight" id="periodRoutes">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>

  <div class="progress-container">
    <div class="progress-bar" id="routesProgress"></div>
    <span class="progress-label" id="routesProgressLabel">0 / 16</span>
  </div>

  <p>Пассажиров:
    <span class="highlight" id="periodPassengers">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>

  <p>Зарплата:
    <span class="highlight" id="salary">
      <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
    </span>
  </p>
</div>


<div class="tile">
  <h3>До повышения</h3>

  <p>Текущая должность:
    <span class="highlight" id="rankNow">—</span>
  </p>

  <p>Следующая ступень:
    <span class="highlight" id="rankNext">—</span>
  </p>

  <p>Осталось кругорейсов:
    <span class="highlight" id="rankLeft">0</span>
  </p>

  <div class="progress-container">
    <div class="progress-bar" id="rankProgress"></div>
    <span class="progress-label" id="rankProgressLabel">0 / 0</span>
  </div>
</div>


<!--  <div class="tile important">
      <p>Водитель, при завершении смены не забывай сдавать маршрутный лист</p>
    </div> -->

<!-- <div class="tile important">
  <p>Выплата зарплаты за первый полупериод декабря</p>

  <a href="https://dashboard.rotorprov.ru/12h1" 
     target="_blank" 
     class="button">
    Открыть
  </a>
</div> -->

  

  </div>
</div>
  <script>
    const pageAccess = null;
const API = "https://rotorbus.ru/api";
const COMPANY = "rotor";

/* =========================
   Helpers
========================= */
function getCookie(name) {
  const match = document.cookie.match(
    new RegExp("(^| )" + name + "=([^;]+)")
  );
  return match ? decodeURIComponent(match[2]) : null;
}

function formatNumber(v) {
  if (v === null || v === undefined) return "0";
  return Number(v).toLocaleString("ru-RU");
}

/* =========================
   Dashboard
========================= */
async function loadDashboard() {
  const login = getCookie("userLogin");
  if (!login) return;

  nickname.textContent = login;

  try {
    const res = await fetch(`${API}/statistics/${COMPANY}`);
    if (!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();
    if (data.status !== "ok") throw new Error("API error");

    const stats = data.statistics.find(
      s => s.user_name === login
    );

    const s = stats || {
      post: "—",
      total_round_trips: 0,
      period_round_trips: 0,
      total_passengers: 0,
      period_passengers: 0,
      period_salary: 0
    };

    /* ===== Promotion ===== */
    const total = Number(s.total_round_trips) || 0;
    const post = (s.post || "").toLowerCase();

    let need = 0;
    let next = "—";

    if (post.includes("3")) {
      need = 70;
      next = "Водитель 2 класса";
      rankNow.textContent = "Водитель 3 класса";
    } 
    else if (post.includes("2")) {
      need = 150;
      next = "Водитель 1 класса";
      rankNow.textContent = "Водитель 2 класса";
    } 
    else if (post.includes("1")) {
      rankNow.textContent = "Водитель 1 класса";
      rankNext.textContent = "Максимум";
      rankLeft.textContent = "0";
      rankProgress.style.width = "100%";
      rankProgressLabel.textContent = "Готово";
      return;
    } 
    else {
      rankNow.textContent = s.post;
      rankNext.textContent = "—";
      rankLeft.textContent = "—";
      return;
    }

    rankNext.textContent = next;

    const left = Math.max(0, need - total);
    rankLeft.textContent = left;

    let percent2 = (total / need) * 100;
    if (percent2 > 100) percent2 = 100;

    rankProgress.style.width = percent2 + "%";
    rankProgressLabel.textContent = `${total} / ${need}`;

    /* ===== UI ===== */
    userRole.textContent = s.post || "—";

    totalRoutes.textContent = formatNumber(s.total_round_trips);
    totalPassengers.textContent = formatNumber(s.total_passengers);

    periodRoutes.textContent = formatNumber(s.period_round_trips);
    periodPassengers.textContent = formatNumber(s.period_passengers);
    salary.textContent = formatNumber(s.period_salary) + " ₽";

    /* ===== Progress ===== */
    const max = 16;
    const current = Number(s.period_round_trips) || 0;
    let percent = (current / max) * 100;
    if (percent > 100) percent = 100;

    routesProgress.style.width = percent + "%";
    routesProgressLabel.textContent = `${current} / ${max}`;

    if (current > max) {
      routesProgress.classList.add("progress-over");
    } else {
      routesProgress.classList.remove("progress-over");
    }

  } catch (e) {
    console.error("Ошибка загрузки:", e);
  }


      

}

window.addEventListener("DOMContentLoaded", loadDashboard);
</script>


</body>
<script src="sidebar.js"></script>
<script src="checkauth.js"></script>
</html>