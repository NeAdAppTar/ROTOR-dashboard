<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="style_db.css">
<link rel="icon" href="icon.png">

<script src="usermenu.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>

<div class="sidebar" id="sidebar"> 
<div class="sidebar-header">
<span class="logo">–†–û–¢–û–†</span>
</div>

<ul class="sidebar-menu">
<li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</span></a></li>
<li><a href="employees.html"><i class="fas fa-users"></i><span>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span></a></li>
<li><a href="routes.html"><i class="fas fa-route"></i><span>–ú–∞—Ä—à—Ä—É—Ç—ã</span></a></li>
<li><a href="vehicles.html"><i class="fas fa-truck"></i><span>–°–ø–∏—Å–æ–∫ –ü–°</span></a></li>
<li><a href="shift_report.html"><i class="fas fa-file"></i><span>–û—Ç—á–µ—Ç</span></a></li>
<li><a href="charter.html"><i class="fas fa-book"></i><span>–£—Å—Ç–∞–≤</span></a></li>
<li><a href="plan.html"><i class="fas fa-calendar"></i><span>–ü–ª–∞–Ω</span></a></li>
<li><a href="t.html"><i class="fas fa-check"></i><span>–¢–µ—Å—Ç—ã</span></a></li>
<li><a href="binds.html"><i class="fas fa-keyboard"></i><span>–ë–∏–Ω–¥—ã –∏ —Ç–∞–±–ª–∏—á–∫–∏</span></a></li>
</ul>

<div class="user-menu" id="userMenu">

<div class="user-menu-item" id="nyBtn">
<i class="fas fa-snowflake"></i>
<span>–ù–ì –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</span>
</div>

<div class="user-menu-item" id="themeBtn">
<i class="fas fa-moon"></i>
<span>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
</div>

<div class="user-menu-item" id="logoutBtn">
<i class="fas fa-sign-out-alt"></i>
<span>–í—ã–π—Ç–∏</span>
</div>

<div class="user-name-display">
<i class="fas fa-user"></i>
<span id="userName">user</span>
</div>

</div>
</div>


<div class="main-content">
<div class="container">

<h1>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h1>

<div class="table-card">
<table class="styled-table">

<thead>
<tr>
<th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
<th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
<th>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º—ã</th>
<th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
<th>–í–∑—ã—Å–∫–∞–Ω–∏—è</th>
<th>–î–µ–π—Å—Ç–≤–∏—è</th>
</tr>
</thead>

<tbody id="employeesTable"></tbody>

</table>
</div>

</div>
</div>

<script>
const pageAccess = ["–î–∏—Ä–µ–∫—Ç–æ—Ä", "–ó–∞–º. –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞", "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"];

const API_BASE = "https://rotorbus.ru/api";
const COMPANY = "rotor";
const NORM = 16;

const table = document.getElementById("employeesTable");

function escapeHtml(str){
return String(str || "")
.replaceAll("&","&amp;")
.replaceAll("<","&lt;")
.replaceAll(">","&gt;");
}

function progressBar(value){

const percent = Math.min((value / NORM) * 100, 100);
const over = value >= NORM ? "progress-over" : "";

return `
<div class="progress-container">
<div class="progress-bar ${over}" style="width:${percent}%"></div>
<span class="progress-label">${value} / ${NORM}</span>
</div>`;
}

function parsePunish(str){
if(!str) return 0;
return Number(str.split("/")[0]) || 0;
}

async function fetchJson(url){
const res = await fetch(url);
return res.json();
}

async function giveWarning(user){

const currentStr = user.disciplinary_actions || "0/3";
const current = parsePunish(currentStr);

if(current >= 3){
alert("–ù–µ–ª—å–∑—è –≤—ã–¥–∞—Ç—å –±–æ–ª—å—à–µ 3 –≤–∑—ã—Å–∫–∞–Ω–∏–π");
return;
}

const newValue = `${current + 1}/3`;

const res = await fetch(`${API_BASE}/user/${COMPANY}/${user.id}`,{
method:"PUT",
headers:{ "Content-Type":"application/json" },
body: JSON.stringify({
disciplinary_actions: newValue
})
});

const data = await res.json();

if(data.status === "ok"){
loadEmployees();
}else{
alert(data.message);
}
}

async function fireUser(user){

if(!confirm(`–£–≤–æ–ª–∏—Ç—å ${user.name}?`)) return;

const res = await fetch(`${API_BASE}/user/${COMPANY}/${user.id}`,{
method:"DELETE"
});

const data = await res.json();

if(data.status === "ok"){
loadEmployees();
}else{
alert(data.message);
}
}

async function loadEmployees(){

table.innerHTML = "<tr><td colspan='6'>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>";

try{

const usersData = await fetchJson(`${API_BASE}/users/${COMPANY}`);
const statsData = await fetchJson(`${API_BASE}/statistics/${COMPANY}`);

const users = usersData.users || [];
const stats = statsData.statistics || [];

table.innerHTML = "";

users.forEach(user => {

const stat = stats.find(s => s.user_name === user.name) || {};

const trips = Number(stat.period_round_trips || 0);
const salary = Number(stat.period_salary || 0);

const punishStr = user.disciplinary_actions || "0/3";
const punish = parsePunish(punishStr);

const tr = document.createElement("tr");

tr.innerHTML = `
<td>${escapeHtml(user.name)}</td>
<td>${escapeHtml(user.post)}</td>
<td>${progressBar(trips)}</td>
<td>${salary.toLocaleString()} ‚ÇΩ</td>

<td>
<span class="status-badge ${
punish === 0 ? 'badge-ok' :
punish === 3 ? 'badge-rej' :
'badge-not'
}">
${escapeHtml(punishStr)}
</span>
</td>

<td class="actions">

<button class="btn-ok" onclick='giveWarning(${JSON.stringify(user)})'>
‚ö† –í—ã–≥–æ–≤–æ—Ä
</button>

<button class="btn-rej" onclick='fireUser(${JSON.stringify(user)})'>
üóë –£–≤–æ–ª–∏—Ç—å
</button>

</td>
`;

table.appendChild(tr);

});

if(!users.length){
table.innerHTML = "<tr><td colspan='6'>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</td></tr>";
}

}catch(err){
table.innerHTML = "<tr><td colspan='6'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>";
console.error(err);
}
}

loadEmployees();

</script>

<script src="sidebar.js"></script>
<script src="checkauth.js"></script>

</body>
</html>
