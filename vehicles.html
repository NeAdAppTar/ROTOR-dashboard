<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Список ПС</title>

  <link rel="stylesheet" href="style_db.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="icon.png">

  <script src="usermenu.js"></script>

  <!-- Иконки -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    .state-new { background-color: #b0dfb0 !important; }   /* Зеленый */
    .state-ne { background-color: #e5d866 !important; }    /* Желтый */
    .state-norm { background-color: transparent !important; }
  </style>
</head>

<body>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span class="logo">РОТОР</span>
    </div>

    <ul class="sidebar-menu">
        <li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>Личный кабинет</span></a></li>
        <li><a href="employees.html"><i class="fas fa-users"></i><span>Список сотрудников</span></a></li>
        <li><a href="routes.html"><i class="fas fa-route"></i><span>Маршруты</span></a></li>
        <li><a href="vehicles.html"><i class="fas fa-truck"></i><span>Список ПС</span></a></li>
        <li><a href="submit_route.html"><i class="fas fa-file"></i><span>Маршрутный лист</span></a></li>
        <li><a href="charter.html"><i class="fas fa-book"></i><span>Устав</span></a></li>
        <li><a href="plan.html"><i class="fas fa-calendar"></i><span>План</span></a></li>
        <li><a href="t.html"><i class="fas fa-check"></i><span>Тесты</span></a></li>
        <li><a href="binds.html"><i class="fas fa-keyboard"></i><span>Бинды и таблички</span></a></li>
    </ul>

    <div class="user-menu" id="userMenu">
        <div class="user-menu-item" id="nyBtn">
            <i class="fas fa-snowflake"></i>
            <span>НГ оформление</span>
        </div>

        <div class="user-menu-item" id="themeBtn">
            <i class="fas fa-moon"></i>
            <span>Тёмная тема</span>
        </div>

        <div class="user-menu-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            <span>Выйти</span>
        </div>

        <div class="user-name-display">
            <i class="fas fa-user"></i>
            <span id="userName">user</span>
        </div>
    </div>
</div>

<div class="main-content">
  <main class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Список ПС</h1>

    <button id="manageEmployeesBtn"
            style="display:none; padding: 8px 14px; font-size: 14px; cursor: pointer;">
        Изменить список ПС
    </button>
</div>

    <p>Автобусы, борт.номера которых начинающиеся с 10хх принадлежат организации, 11хх — личный ПС сотрудников.</p>

    <div id="loading" class="loading">Получение информации от сервера...</div>

    <div id="tableContainer" style="display:none;">
      <table class="styled-table" id="vehiclesTable">
        <thead>
          <tr>
            <th>Бортовой номер</th>
            <th>Гос. номер</th>
            <th>Модель</th>
            <th>Построен</th>
            <th>С (эксплуатации)</th>
            <th>Примечание</th>
          </tr>
        </thead>
        <tbody id="vehiclesBody"></tbody>
      </table>
      <p id="summary" class="summary"></p>
    </div>
  </main>
</div>

<script>
const pageAccess = null;
const ALLOWED_POSTS = [
    "Директор",
    "Зам. директора",
    "Технический администратор"
];
// Получение cookie по имени
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
}

async function checkAccessForButton() {
    const username = getCookie("userLogin");

    if (!username) {
        console.warn("Cookie 'userLogin' не найдено");
        return;
    }

    try {
        const response = await fetch("https://transdigital.pythonanywhere.com/api/get_user_info/rotor", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: username })
        });

        const json = await response.json();
        if (json.status !== "ok") {
            console.warn("Ошибка получения данных пользователя:", json.message);
            return;
        }

        const userPost = json.post;

        if (ALLOWED_POSTS.includes(userPost)) {
            document.getElementById("manageEmployeesBtn").style.display = "inline-block";
        }

    } catch (error) {
        console.error("Ошибка запроса API:", error);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("manageEmployeesBtn");
    btn.onclick = () => window.location.href = "vehicles-a.html";

    checkAccessForButton();
});
async function loadVehicles() {
    const api = "https://transdigital.pythonanywhere.com/api/get_vehicles/rotor";

    const loading = document.getElementById("loading");
    const tbody = document.getElementById("vehiclesBody");
    const tableContainer = document.getElementById("tableContainer");
    const summary = document.getElementById("summary");

    try {
        const response = await fetch(api);
        if (!response.ok) throw new Error("Ошибка API");

        const data = await response.json();
        if (data.status !== "ok") throw new Error("API вернул ошибку");

        tbody.innerHTML = "";
        let count = 0;

        data.vehicles.forEach(v => {
            const tr = document.createElement("tr");

            // Цвет строки
            if (v.state === "new") tr.classList.add("state-new");
            else if (v.state === "ne") tr.classList.add("state-ne");
            else tr.classList.add("state-norm");

            tr.innerHTML = `
                <td>${v.board_number || "-"}</td>
                <td>${v.state_number || "-"}</td>
                <td>${v.model || "-"}</td>
                <td>${v.built || "-"}</td>
                <td>${v.since || "-"}</td>
                <td>${v.note || ""}</td>
            `;

            tbody.appendChild(tr);
            count++;
        });

        loading.style.display = "none";
        tableContainer.style.display = "block";
        summary.innerHTML = `Общее количество ПС: <b>${count}</b>`;

    } catch (err) {
        loading.textContent = "Ошибка загрузки: " + err.message;
    }
}

loadVehicles();
</script>

<script src="sidebar.js"></script>
<script src="checkauth.js"></script>
</body>
</html>
