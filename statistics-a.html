<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="style_db.css">
<link rel="icon" href="icon.png">

<script src="usermenu.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<style>
    table td,
table th {
    white-space: nowrap;
}


</style>

<body>

<!-- SIDEBAR -->
<div class="sidebar">

<div class="sidebar-header">
<span class="logo">–†–û–¢–û–†</span>
</div>

<ul class="sidebar-menu">
<li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</span></a></li>
<li><a href="employees.html"><i class="fas fa-users"></i><span>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span></a></li>
<li><a href="routes.html"><i class="fas fa-route"></i><span>–ú–∞—Ä—à—Ä—É—Ç—ã</span></a></li>
<li><a href="vehicles.html"><i class="fas fa-truck"></i><span>–°–ø–∏—Å–æ–∫ –ü–°</span></a></li>
<li><a href="shift_report.html"><i class="fas fa-file"></i><span>–û—Ç—á–µ—Ç</span></a></li>
<li><a href="charter.html"><i class="fas fa-book"></i><span>–£—Å—Ç–∞–≤</span></a></li>
<li><a href="plan.html"><i class="fas fa-calendar"></i><span>–ü–ª–∞–Ω</span></a></li>
<li><a href="t.html"><i class="fas fa-check"></i><span>–¢–µ—Å—Ç—ã</span></a></li>
<li><a href="binds.html"><i class="fas fa-keyboard"></i><span>–ë–∏–Ω–¥—ã –∏ —Ç–∞–±–ª–∏—á–∫–∏</span></a></li>
</ul>

<div class="user-menu" id="userMenu">

<div class="user-menu-item" id="nyBtn">
<i class="fas fa-snowflake"></i>
<span>–ù–ì –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</span>
</div>

<div class="user-menu-item" id="themeBtn">
<i class="fas fa-moon"></i>
<span>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
</div>

<div class="user-menu-item" id="logoutBtn">
<i class="fas fa-sign-out-alt"></i>
<span>–í—ã–π—Ç–∏</span>
</div>

<div class="user-name-display">
<i class="fas fa-user"></i>
<span id="userName">user</span>
</div>

</div>
</div>


<!-- MAIN -->
<div class="main-content">
<div class="container">

<h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>

<div class="table-card">
<table class="styled-table">

<thead>
<tr>
<th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>

<th>–ö—Ä—É–≥–æ—Ä–µ–π—Å—ã (–æ–±—â–∏–µ)</th>
<th>–ö—Ä—É–≥–æ—Ä–µ–π—Å—ã (–ø–µ—Ä–∏–æ–¥)</th>

<th>–ü–∞—Å—Å–∞–∂–∏—Ä—ã (–æ–±—â–∏–µ)</th>
<th>–ü–∞—Å—Å–∞–∂–∏—Ä—ã (–ø–µ—Ä–∏–æ–¥)</th>

<th>–ó–∞—Ä–ø–ª–∞—Ç–∞ (–æ–±—â–∞—è)</th>
<th>–ó–∞—Ä–ø–ª–∞—Ç–∞ (–ø–µ—Ä–∏–æ–¥)</th>

<th>–î–µ–π—Å—Ç–≤–∏–µ</th>
</tr>
</thead>

<tbody id="statsTable"></tbody>

</table>
</div>

</div>
</div>


<script>
const pageAccess = ["–î–∏—Ä–µ–∫—Ç–æ—Ä", "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"];

const API = "https://rotorbus.ru/api";
const COMPANY = "rotor";

const table = document.getElementById("statsTable");


async function loadStats(){

table.innerHTML = "<tr><td colspan='8'>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>";

try{

const res = await fetch(`${API}/statistics/${COMPANY}`);
const data = await res.json();

if(data.status !== "ok"){
table.innerHTML = "<tr><td colspan='8'>–û—à–∏–±–∫–∞</td></tr>";
return;
}

table.innerHTML = "";

data.statistics.forEach(row => {

const tr = document.createElement("tr");

tr.innerHTML = `

<td>${row.user_name}</td>

<td><input value="${row.total_round_trips}" id="tr_${row.user_name}"></td>
<td><input value="${row.period_round_trips}" id="pr_${row.user_name}"></td>

<td><input value="${row.total_passengers}" id="tp_${row.user_name}"></td>
<td><input value="${row.period_passengers}" id="pp_${row.user_name}"></td>

<td><input value="${row.total_salary}" id="ts_${row.user_name}"></td>
<td><input value="${row.period_salary}" id="ps_${row.user_name}"></td>

<td>
<button onclick="saveStats('${row.user_name}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</td>
`;

table.appendChild(tr);

});

}catch(e){
console.error(e);
table.innerHTML = "<tr><td colspan='8'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>";
}

}


async function saveStats(name){

const body = {

total_round_trips: Number(document.getElementById(`tr_${name}`).value),
period_round_trips: Number(document.getElementById(`pr_${name}`).value),

total_passengers: Number(document.getElementById(`tp_${name}`).value),
period_passengers: Number(document.getElementById(`pp_${name}`).value),

total_salary: Number(document.getElementById(`ts_${name}`).value),
period_salary: Number(document.getElementById(`ps_${name}`).value)

};

try{

const res = await fetch(`${API}/statistics/${COMPANY}/user/${encodeURIComponent(name)}`,{
method:"PUT",
headers:{ "Content-Type":"application/json" },
body: JSON.stringify(body)
});

const data = await res.json();

if(data.status === "ok"){
alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}else{
alert(data.message);
}

}catch(e){
console.error(e);
alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
}

}


loadStats();

</script>

<script src="sidebar.js"></script>
<script src="checkauth.js"></script>
</body>
</html>
