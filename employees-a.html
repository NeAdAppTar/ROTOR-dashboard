<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>ROTOR — Админ: Управление пользователями</title>
  <link rel="stylesheet" href="style_db.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="icon.png">
  <script src="usermenu.js"></script> 
  <style>
    /* Доп. маленькие правки для админки */
    .actions-btn { padding:6px 10px; border-radius:8px; margin-right:6px; cursor:pointer; border:none; }
    .btn-add { background:var(--primary); color:var(--black); }
    .btn-edit { background:#60a5fa; color:#fff; }
    .btn-delete { background:#ef4444; color:#fff; }
    .form-inline { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:18px; }
    .form-inline input { padding:8px 10px; border-radius:10px; border:1px solid #ddd; min-width:180px; }
    .note { margin:12px 0; color:var(--muted); }
    .toast { position:fixed; right:20px; bottom:20px; padding:12px 18px; border-radius:12px; box-shadow:var(--shadow); background:#111; color:#fff; display:none; z-index:9999; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:2000; }
    .modal .card { background:var(--card-bg); padding:20px; border-radius:12px; width:420px; max-width:95%; box-shadow:var(--shadow); }
    .modal .card h3 { margin-bottom:12px; }
    .small { font-size:0.9rem; color:var(--muted); }
    @media (max-width:720px){
      .form-inline input { min-width:120px; }
    }
  </style>
</head>
<body>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- SIDEBAR (взял вашу структуру) -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header"><span class="logo">РОТОР</span></div>
  <ul class="sidebar-menu">
    <li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>Личный кабинет</span></a></li>
    <li><a href="employees.html"><i class="fas fa-users"></i><span>Список сотрудников</span></a></li>
    <!-- ... остальные пункты ... -->
  </ul>
  <div class="user-menu" id="userMenu">
    <div class="user-menu-item" id="themeBtn"><i class="fas fa-moon"></i><span>Тёмная тема</span></div>
    <div class="user-menu-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Выйти</span></div>
    <div class="user-name-display"><i class="fas fa-user"></i><span id="userName">admin</span></div>
  </div>
</div>

<!-- MAIN -->
<div class="main-content">
  <div class="container">
    <h1>Админ: Управление пользователями</h1>
    <p class="note">Используется API TransDigital — добавление/обновление/удаление/список пользователей. (endpoint: <code>/api/*/{company}</code>)</p>

    <!-- Форма добавления -->
    <div class="table-card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div class="form-inline">
          <input id="newName" placeholder="Логин (name)"/>
          <input id="newPass" placeholder="Пароль" type="password"/>
          <button class="actions-btn btn-add" id="addBtn"><i class="fas fa-plus"></i> Добавить</button>
          <select id="companySelect" style="padding:8px 10px; border-radius:8px;">
            <option value="rotor">rotor</option>
            <!-- при необходимости добавить другие компании -->
          </select>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <input id="searchInput" placeholder="Поиск по логину..." />
          <button class="actions-btn" id="refreshBtn" title="Обновить список"><i class="fas fa-sync"></i></button>
        </div>
      </div>

      <div id="loading" class="loading">Загрузка пользователей...</div>

      <div class="table-card" style="margin-top:14px; padding:8px;">
        <table class="styled-table" id="usersTable" style="display:none;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Логин</th>
              <th>Пароль</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Модал для редактирования -->
<div class="modal" id="editModal">
  <div class="card">
    <h3>Редактировать пароль</h3>
    <div>
      <label class="small">Логин</label>
      <div id="editLogin" style="font-weight:700;margin-bottom:8px;"></div>
      <label class="small">Новый пароль</label>
      <input id="editPass" placeholder="Новый пароль" />
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="actions-btn" id="cancelEdit">Отмена</button>
        <button class="actions-btn btn-edit" id="saveEdit">Сохранить</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // Базовый URL API — используйте company в маршрутах
  const API_BASE = 'https://transdigital.pythonanywhere.com/api';
  // Элементы
  const usersTable = document.getElementById('usersTable');
  const usersBody = document.getElementById('usersBody');
  const loading = document.getElementById('loading');
  const addBtn = document.getElementById('addBtn');
  const newName = document.getElementById('newName');
  const newPass = document.getElementById('newPass');
  const companySelect = document.getElementById('companySelect');
  const refreshBtn = document.getElementById('refreshBtn');
  const searchInput = document.getElementById('searchInput');

  const editModal = document.getElementById('editModal');
  const editLogin = document.getElementById('editLogin');
  const editPass = document.getElementById('editPass');
  const saveEdit = document.getElementById('saveEdit');
  const cancelEdit = document.getElementById('cancelEdit');

  const toastEl = document.getElementById('toast');

  let usersCache = []; // хранит массив пользователей {id, name, password}
  let editingUser = null;

  function showToast(text, ok=true){
    toastEl.textContent = text;
    toastEl.style.background = ok ? '#111' : '#b91c1c';
    toastEl.style.display = 'block';
    setTimeout(()=> toastEl.style.display = 'none', 3000);
  }

  // Вызов: получить всех пользователей
  async function fetchAllUsers(){
    loading.style.display = 'block';
    usersTable.style.display = 'none';
    const company = companySelect.value;

    try {
        const res = await fetch(`${API_BASE}/get_all_users/${company}`);
        const data = await res.json();

        if(data.status === 'ok' && Array.isArray(data.users)){
            usersCache = data.users.map(u => ({ id: u.id, name: u.name, password: u.password }));
            renderUsersTable(usersCache);

            loading.style.display = 'none';
            usersTable.style.display = 'table';
        } else {
            throw new Error(data.message || 'Неверный ответ');
        }
    } catch (err) {
        loading.textContent = 'Ошибка: ' + err.message;
        showToast('Ошибка: ' + err.message, false);
    }
}



  // Рендер таблицы
  function renderUsersTable(users){
    usersBody.innerHTML = '';
    const q = searchInput.value.trim().toLowerCase();
    users.filter(u => !q || u.name.toLowerCase().includes(q)).forEach(user => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(user.id)}</td>
        <td>${escapeHtml(user.name)}</td>
        <td><input type="password" value="${escapeHtml(user.password)}" readonly style="border:none;background:transparent;"/></td>
        <td>
          <button class="actions-btn btn-edit" data-name="${escapeHtml(user.name)}" onclick="onEdit('${escapeHtml(user.name)}')"><i class="fas fa-edit"></i> Изменить</button>
          <button class="actions-btn" onclick="onView('${escapeHtml(user.name)}')"><i class="fas fa-eye"></i> Просмотр</button>
          <button class="actions-btn btn-delete" onclick="onDelete('${escapeHtml(user.name)}')"><i class="fas fa-trash"></i> Удалить</button>
        </td>
      `;
      usersBody.appendChild(tr);
    });
  }

  // Защита простая — экранируем спецсимволы для вставки в HTML
  function escapeHtml(str){
    if(str === undefined || str === null) return '';
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // Добавить пользователя
  addBtn.addEventListener('click', async ()=>{
    const name = newName.value.trim();
    const password = newPass.value;
    const company = companySelect.value;
    if(!name || !password){ showToast('Заполните логин и пароль', false); return; }
    try {
      addBtn.disabled = true;
      const res = await fetch(`${API_BASE}/add_user/${company}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name, password })
      });
      const data = await res.json();
      if(data.status === 'ok'){
        showToast('Пользователь добавлен');
        newName.value = ''; newPass.value = '';
        await fetchAllUsers();
      } else {
        throw new Error(data.message || 'Ошибка сервера');
      }
    } catch (err) {
      showToast('Ошибка: ' + err.message, false);
    } finally { addBtn.disabled = false; }
  });

  // Редактировать (открыть модал)
  window.onEdit = function(name){
    editingUser = name;
    editLogin.textContent = name;
    editPass.value = '';
    editModal.style.display = 'flex';
  };

  cancelEdit.addEventListener('click', ()=> { editModal.style.display = 'none'; editingUser = null; });

  saveEdit.addEventListener('click', async ()=>{
    const newPassword = editPass.value;
    const company = companySelect.value;
    if(!editingUser || !newPassword){ showToast('Укажите новый пароль', false); return; }
    try {
      saveEdit.disabled = true;
      const res = await fetch(`${API_BASE}/update_user/${company}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name: editingUser, password: newPassword })
      });
      const data = await res.json();
      if(data.status === 'ok'){
        showToast('Пароль обновлён');
        editModal.style.display = 'none';
        editingUser = null;
        await fetchAllUsers();
      } else {
        throw new Error(data.message || 'Ошибка сервера');
      }
    } catch(err){
      showToast('Ошибка: ' + err.message, false);
    } finally { saveEdit.disabled = false; }
  });

  // Просмотр подробностей пользователя
  window.onView = async function(name){
    const company = companySelect.value;
    try {
      const res = await fetch(`${API_BASE}/get_user/${company}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if(data.status === 'ok'){
        // Покажем alert с инфой (можно заменить на модал)
        alert(`ID: ${data.id}\nИмя: ${data.name}\nПароль: ${data.password}`);
      } else {
        throw new Error(data.message || 'Не удалось получить данные');
      }
    } catch(err){
      showToast('Ошибка: ' + err.message, false);
    }
  };

  // Удаление
  window.onDelete = async function(name){
    if(!confirm(`Удалить пользователя "${name}"?`)) return;
    const company = companySelect.value;
    try {
      const res = await fetch(`${API_BASE}/delete_user/${company}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if(data.status === 'ok'){
        showToast('Пользователь удалён');
        await fetchAllUsers();
      } else {
        throw new Error(data.message || 'Ошибка удаления');
      }
    } catch(err){
      showToast('Ошибка: ' + err.message, false);
    }
  };

  // Поиск + обновление
  searchInput.addEventListener('input', ()=> renderUsersTable(usersCache));
  refreshBtn.addEventListener('click', fetchAllUsers);
  companySelect.addEventListener('change', fetchAllUsers);

  // Начальная загрузка
  fetchAllUsers();

  // Закрытие модала при клике вне карточки
  editModal.addEventListener('click', (e)=> { if(e.target === editModal) { editModal.style.display = 'none'; editingUser = null; } });

</script>

</body>
<script defer src="sidebar.js"></script>
</html>
