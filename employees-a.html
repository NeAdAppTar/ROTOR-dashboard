<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Управление пользователями</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="icon" type="image/png" href="icon.png">
  <link rel="stylesheet" href="style_db.css">
  <link rel="stylesheet" href="style_a.css">
  <link rel="stylesheet" href="modal.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>

<!-- ================= SIDEBAR (НЕ ТРОГАЕМ) ================= -->
<div class="sidebar" id="sidebar"> 
  <div class="sidebar-header">
    <span class="logo">РОТОР</span>
  </div>

  <ul class="sidebar-menu">
    <li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>Личный кабинет</span></a></li>
    <li><a href="employees.html"><i class="fas fa-users"></i><span>Список сотрудников</span></a></li>
    <li><a href="routes.html"><i class="fas fa-route"></i><span>Маршруты</span></a></li>
    <li><a href="vehicles.html"><i class="fas fa-truck"></i><span>Список ПС</span></a></li>
    <li><a href="submit_route.html"><i class="fas fa-file"></i><span>Маршрутный лист</span></a></li>
    <li><a href="charter.html"><i class="fas fa-book"></i><span>Устав</span></a></li>
    <li><a href="plan.html"><i class="fas fa-calendar"></i><span>План</span></a></li>
    <li><a href="t.html"><i class="fas fa-check"></i><span>Тесты</span></a></li>
    <li><a href="binds.html"><i class="fas fa-keyboard"></i><span>Бинды</span></a></li>
  </ul>

  <div class="user-menu">
    <div class="user-menu-item" id="logoutBtn">
      <i class="fas fa-sign-out-alt"></i>
      <span>Выйти</span>
    </div>

    <div class="user-name-display">
      <i class="fas fa-user"></i>
      <span id="userName">user</span>
    </div>
  </div>
</div>

<!-- ================= MAIN ================= -->
<div class="main-content">
  <div class="container">
    <h1>Управление пользователями</h1>

    <!-- ===== ADD ===== -->
    <div class="table-card">
      <div class="form-inline">
        <input id="newLogin" placeholder="Логин">
        <input id="newPassword" type="password" placeholder="Пароль">
        <input id="newPost" placeholder="Должность">
        <input id="newAccount" placeholder="Банк">
        <input id="newVK" placeholder="VK">
        <input id="newDA" placeholder="Взыскания">
        <input id="newNote" placeholder="Заметка">
        <button id="addBtn" class="actions-btn btn-add">
          <i class="fas fa-plus"></i> Добавить
        </button>
      </div>
    </div>

    <!-- ===== TABLE ===== -->
    <div class="table-card">
      <table class="styled-table">
        <thead>
          <tr>
            <th>Логин</th>
            <th>Должность</th>
            <th>Банк</th>
            <th>VK</th>
            <th>Взыскания</th>
            <th>Заметка</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================= MODAL ================= -->
<div id="editModal" class="modal">
  <div class="modal-card">
    <h3>Редактирование пользователя</h3>

    <div class="modal-field"><label>Должность</label><input id="editPost"></div>
    <div class="modal-field"><label>Банк</label><input id="editAccount"></div>
    <div class="modal-field"><label>VK</label><input id="editVK"></div>
    <div class="modal-field"><label>Взыскания</label><input id="editDA"></div>
    <div class="modal-field"><label>Заметка</label><input id="editNote"></div>

    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeEdit()">Отмена</button>
      <button class="modal-btn save" id="saveEdit">Сохранить</button>
    </div>
  </div>
</div>

<!-- ================= ACCESS ================= -->
<script>
  const pageAccess = [
    "директор",
    "зам. директора",
    "технический администратор",
    "начальник учебного центра",
    "зам. начальника учебного центра"
  ];
</script>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs, getDoc, doc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCW9kzlx94qJWkpphG3kGmVskHezLf6Bb0",
  authDomain: "rotorbus-ae2a5.firebaseapp.com",
  projectId: "rotorbus-ae2a5",
  appId: "1:363736805548:web:590cec31bb5671e115af09",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentPost = "";
let editUid = null;

const usersBody = document.getElementById("usersBody");

/* ===== AUTH CHECK ===== */
onAuthStateChanged(auth, async user => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  const snap = await getDoc(doc(db, "users", user.uid));
  if (!snap.exists()) {
    location.href = "no-access.html";
    return;
  }

  currentPost = (snap.data().post || "").toLowerCase();
  document.getElementById("userName").textContent = snap.data().login;

  if (!pageAccess.includes(currentPost)) {
    location.href = "no-access.html";
    return;
  }

  loadUsers();
});

/* ===== ROLE CHECK ===== */
function checkRole() {
  if (!pageAccess.includes(currentPost)) {
    alert("Нет прав");
    throw new Error("NO ACCESS");
  }
}

/* ===== LOAD USERS ===== */
async function loadUsers() {
  usersBody.innerHTML = "";
  const snap = await getDocs(collection(db, "users"));

  snap.forEach(d => {
    const u = d.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.login}</td>
      <td>${u.post}</td>
      <td>${u.account}</td>
      <td>${u.vk}</td>
      <td>${u.disciplinary_actions}</td>
      <td>${u.note}</td>
      <td>
        <button onclick="openEdit('${d.id}')"><i class="fas fa-pen"></i></button>
        <button onclick="deleteUser('${d.id}')"><i class="fas fa-trash"></i></button>
      </td>`;
    usersBody.appendChild(tr);
  });
}

/* ===== ADD ===== */
addBtn.onclick = async () => {
  checkRole();

  const login = newLogin.value.trim();
  const password = newPassword.value.trim();
  if (!login || !password) return;

  const cred = await createUserWithEmailAndPassword(
    auth,
    `${login}@rotorprov.ru`,
    password
  );

  await setDoc(doc(db, "users", cred.user.uid), {
    login,
    post: newPost.value,
    account: newAccount.value,
    vk: newVK.value,
    disciplinary_actions: newDA.value,
    note: newNote.value
  });

  loadUsers();
};

/* ===== EDIT ===== */
window.openEdit = async (uid) => {
  checkRole();
  editUid = uid;

  const snap = await getDoc(doc(db, "users", uid));
  const u = snap.data();

  editPost.value = u.post || "";
  editAccount.value = u.account || "";
  editVK.value = u.vk || "";
  editDA.value = u.disciplinary_actions || "";
  editNote.value = u.note || "";

  editModal.classList.add("open");
};

window.closeEdit = () => {
  editModal.classList.remove("open");
  editUid = null;
};

saveEdit.onclick = async () => {
  checkRole();
  if (!editUid) return;

  await updateDoc(doc(db, "users", editUid), {
    post: editPost.value,
    account: editAccount.value,
    vk: editVK.value,
    disciplinary_actions: editDA.value,
    note: editNote.value
  });

  closeEdit();
  loadUsers();
};

/* ===== DELETE ===== */
window.deleteUser = async (uid) => {
  checkRole();
  if (!confirm("Удалить пользователя?")) return;
  await deleteDoc(doc(db, "users", uid));
  loadUsers();
};

/* ===== LOGOUT ===== */
logoutBtn.onclick = async () => {
  await signOut(auth);
  location.href = "login.html";
};
</script>

</body>
</html>
