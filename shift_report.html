<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Завершение смены</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="style_db.css">
<link rel="icon" href="icon.png">

<style>
  .shift-card {
    max-width: 480px;
    margin: 0 auto;
    background: #ffffff;
    border-radius: 16px;
    padding: 24px;
  }

  .shift-card h2 {
    margin-top: 0;
    margin-bottom: 16px;
    text-align: center;
  }

  .form-group {
    margin-bottom: 14px;
  }

  .form-group label {
    display: block;
    font-size: 13px;
    color: #64748b;
    margin-bottom: 4px;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    font-size: 14px;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #3b82f6;
    background: #f8fafc;
  }

  .submit-btn {
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    font-size: 15px;
    border-radius: 12px;
    border: none;
    background: #2563eb;
    color: white;
    cursor: pointer;
    transition: background 0.2s;
  }

  .submit-btn:hover {
    background: #1e40af;
  }

  .hint {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 4px;
  }
</style>
</head>

<body>
<div class="main-content">
<main class="container">

<h1>Завершение смены</h1>

<div class="shift-card">

  <h2>Отчёт по смене</h2>

  <div class="form-group">
    <label>Маршрут</label>
    <select id="routeSelect"></select>
  </div>

  <div class="form-group">
    <label>Автобус</label>
    <select id="vehicleSelect"></select>
  </div>

  <div class="form-group">
    <label>Кругорейсы</label>
    <input id="rounds" type="number" min="0">
    <div class="hint">Количество выполненных кругов</div>
  </div>

  <div class="form-group">
    <label>Пассажиры</label>
    <input id="passengers" type="number" min="0">
  </div>

  <div class="form-group">
    <label>Доказательство</label>
    <input id="proof" placeholder="Ссылка на фото или документ">
  </div>

  <button class="submit-btn" onclick="send()">Отправить отчёт</button>

</div>

</main>
</div>

<script>
const COMPANY = "rotor";

/* =========================
   Вспомогательные функции
========================= */

function getCookie(name) {
  return document.cookie
    .split('; ')
    .find(row => row.startsWith(name + '='))
    ?.split('=')[1];
}

const userName = decodeURIComponent(getCookie("userLogin") || "");

/* =========================
   Загрузка данных
========================= */

async function loadRoutes() {
  const res = await fetch(`https://rotorbus.ru/api/routes/${COMPANY}`);
  const data = await res.json();

  routeSelect.innerHTML = "";

  data.routes.forEach(r => {
    const option = document.createElement("option");
    option.value = r.route;
    option.textContent = r.route;
    routeSelect.appendChild(option);
  });
}

async function loadVehicles() {
  const res = await fetch(`https://rotorbus.ru/api/vehicles/${COMPANY}`);
  const data = await res.json();

  vehicleSelect.innerHTML = "";

  data.vehicles.forEach(v => {
    const option = document.createElement("option");
    option.value = v.id;
    option.textContent = `${v.model} (${v.board_number})`;
    vehicleSelect.appendChild(option);
  });
}

/* =========================
   Отправка отчёта
========================= */

async function send() {
  if (!userName) {
    alert("Пользователь не найден");
    return;
  }

  if (!rounds.value || !passengers.value) {
    alert("Заполните все обязательные поля");
    return;
  }

  const body = {
    user_name: userName,
    date: new Date().toISOString().split("T")[0],
    route: routeSelect.value,
    num_round_trips: Number(rounds.value),
    num_passengers: Number(passengers.value),
    proof: proof.value,
    vehicle_id: Number(vehicleSelect.value)
  };

  const res = await fetch(`https://rotorbus.ru/api/report/${COMPANY}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    alert("Ошибка отправки отчёта");
    return;
  }

  window.location.href = `/dashboard/${userName}`;
}

/* =========================
   Init
========================= */

loadRoutes();
loadVehicles();
</script>

</body>
</html>
