<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Завершение смены</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="style_db.css">
<link rel="icon" href="icon.png">
<script src="usermenu.js"></script> 

<style>
  .shift-card {
    max-width: 480px;
    margin: 0 auto;
    background: #ffffff;
    border-radius: 16px;
    padding: 24px;
  }

  .shift-card h2 {
    margin-top: 0;
    margin-bottom: 16px;
    text-align: center;
  }

  .form-group {
    margin-bottom: 14px;
  }

  .form-group label {
    display: block;
    font-size: 13px;
    color: #64748b;
    margin-bottom: 4px;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 10px 0px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    font-size: 14px;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #3b82f6;
    background: #f8fafc;
  }

  .submit-btn {
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    font-size: 15px;
    border-radius: 12px;
    border: none;
    background: #00690c;
    color: white;
    cursor: pointer;
    transition: background 0.2s;
  }

  .submit-btn:hover {
    background: #006428;
  }

  .hint {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 4px;
  }
  /* Ночная тема */
.dark .shift-card {
  background: #1e293b;         /* тёмно-синий графит */
  color: #e2e8f0;              /* светлый текст */
}

.dark-theme .shift-card h2 {
  color: #f1f5f9;
}

.dark .form-group label {
  color: #94a3b8;              /* серый текст */
}

.dark .form-group input,
.dark .form-group select {
  background: #0f172a;         /* почти чёрный */
  color: #e2e8f0;
  border: 1px solid #334155;   /* тёмная рамка */
}

.dark .form-group input:focus,
.dark .form-group select:focus {
  outline: none;
  border-color: #3b82f6;       /* синий акцент */
  background: #1e293b;
}

.dark .submit-btn {
  background: #059669;         /* мятно-зелёный */
  color: white;
}

.dark .submit-btn:hover {
  background: #047857;         /* темнее при наведении */
}

.dark .hint {
  color: #64748b;
}

</style>
</head>

<body>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="sidebar" id="sidebar"> 
    <div class="sidebar-header">
        <span class="logo">РОТОР</span>
    </div>

    <ul class="sidebar-menu">
        <li><a href="employee_dashboard.html"><i class="fas fa-user"></i><span>Личный кабинет</span></a></li>
        <li><a href="employees.html"><i class="fas fa-users"></i><span>Список сотрудников</span></a></li>
        <li><a href="routes.html"><i class="fas fa-route"></i><span>Маршруты</span></a></li>
        <li><a href="vehicles.html"><i class="fas fa-truck"></i><span>Список ПС</span></a></li>
        <li><a href="submit_route.html"><i class="fas fa-file"></i><span>Маршрутный лист</span></a></li>
        <li><a href="charter.html"><i class="fas fa-book"></i><span>Устав</span></a></li>
        <li><a href="plan.html"><i class="fas fa-calendar"></i><span>План</span></a></li>
        <li><a href="t.html"><i class="fas fa-check"></i><span>Тесты</span></a></li>
        <li><a href="binds.html"><i class="fas fa-keyboard"></i><span>Бинды и таблички</span></a></li>
    </ul>

    <div class="user-menu" id="userMenu">

      <div class="user-menu-item" id="nyBtn">
      <i class="fas fa-snowflake"></i>
      <span>НГ оформление</span>
      </div>

    <div class="user-menu-item" id="themeBtn">
        <i class="fas fa-moon"></i>
        <span>Тёмная тема</span>
    </div>

    <div class="user-menu-item" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Выйти</span>
    </div>

    <div class="user-name-display">
        <i class="fas fa-user"></i>
        <span id="userName">user</span>
    </div>

</div>
</div> 

<div class="main-content">
<main class="container">

<h1>Завершение смены</h1>

<div class="shift-card">

  <h2>Отчёт по смене</h2>

  <div class="form-group">
    <label>Маршрут</label>
    <select id="routeSelect"></select>
  </div>

  <div class="form-group">
    <label>Автобус</label>
    <select id="vehicleSelect"></select>
  </div>

  <div class="form-group">
    <label>Кругорейсы</label>
    <input id="rounds" type="number" min="0">
    <div class="hint">Количество выполненных кругов</div>
  </div>

  <div class="form-group">
    <label>Пассажиры</label>
    <input id="passengers" type="number" min="0">
  </div>

  <div class="form-group">
    <label>Доказательство</label>
    <input id="proof" placeholder="Ссылка на фото или документ">
  </div>

  <button class="submit-btn" onclick="send()">Отправить отчёт</button>

</div>

</main>
</div>

<script>
  const pageAccess = ["Директор", "Технический администратор"];

const COMPANY = "rotor";

function getCookie(name) {
  return document.cookie
    .split('; ')
    .find(row => row.startsWith(name + '='))
    ?.split('=')[1];
}

const userName = decodeURIComponent(getCookie("userLogin") || "");

async function loadRoutes() {
  const res = await fetch(`https://rotorbus.ru/api/routes/${COMPANY}`);
  const data = await res.json();

  routeSelect.innerHTML = "";

  data.routes.forEach(r => {
    const option = document.createElement("option");
    option.value = r.route;
    option.textContent = r.route;
    routeSelect.appendChild(option);
  });
}

async function loadVehicles() {
  const res = await fetch(`https://rotorbus.ru/api/vehicles/${COMPANY}`);
  const data = await res.json();

  vehicleSelect.innerHTML = "";

  data.vehicles.forEach(v => {
    const option = document.createElement("option");
    option.value = v.id;
    option.textContent = `${v.model} (${v.board_number})`;
    vehicleSelect.appendChild(option);
  });
}

async function send() {
  if (!userName) {
    alert("Пользователь не найден");
    return;
  }

  if (!rounds.value || !passengers.value) {
    alert("Заполните все обязательные поля");
    return;
  }

  const body = {
    user_name: userName,
    date: new Date().toISOString().split("T")[0],
    route: routeSelect.value,
    num_round_trips: Number(rounds.value),
    num_passengers: Number(passengers.value),
    proof: proof.value,
    vehicle_id: Number(vehicleSelect.value)
  };

  const res = await fetch(`https://rotorbus.ru/api/report/${COMPANY}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    alert("Ошибка отправки отчёта");
    return;
  }

  window.location.href = `/employee_dashboard`;
}


loadRoutes();
loadVehicles();
</script>

</body>
<script src="sidebar.js"></script>
<script src="checkauth.js"></script>
</html>
